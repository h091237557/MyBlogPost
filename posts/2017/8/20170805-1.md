# Node之可擴展性---資料的切分

在這系統的文章中，我們的第一篇有提到，根據`The Art of scalability`的內容，在擴展系統時，可以使用以下三個維度來進行說明 : 

* X 軸 : 複制 
* Y 軸 : 以服務/功能分解
* Z 軸 : 以資料來分解

然後我們這篇文章要來說明`資料的切分`。

## 為什麼要資料切分呢 ?
我們在實際上使用資料庫時，例如`mysql`，我們雖然可以透過將資料庫複制，來分散單機的流量，來增加他的性能，但是當資料庫過於龐大時，很難由一台主機來處理。所以這時我們就是需要用到資料切分。

## 什麼是資料切分呢 ?
`Data Partition`或`Sharding`就是指資料切分，他的概念簡單的說就是 : 

> 將一個資料庫切分成多個部份，放到不同的 server 上

基本上根據它的切分方式可以分為以下兩種 : 

### 垂直切分
這種類型的切分，就是將相同類務的表，切分成到同一個 server ，例如假設我們某個資料庫，它有以下的資料表 : 

* 客戶資訊
* 訂單資訊
* 訂單明細資訊
* 進貨資訊

這時如果發現，這個資料庫太大時，要進行切分時，就可以針對`業務`類別，來進行切分，如上例子來看，我們將這個資料庫，切分成三個資料庫 : 

* 訂單資訊、訂單明細資訊
* 客戶資訊
* 進貨資訊

垂直切分這種方法適合以下幾種狀況 : 

> 業務之間明確、清晰且資料表數量多

當然實際上應用時，沒有著麼的簡單，業務也不一定會分的如此的明確，某些方面切分時，只能不停的進行分析，分析每個表 join 的對象與操作數量，什麼表的寫需求較多，什麼表的讀需求較多，然後已此分析結果來進行切分，這樣雖然切分時會很費力，但效能肯定是可以上升的。

### 水平切分
你想想雖然上面的垂直前分，可以根據業務類別，將多個表分散到不同的資料庫去，但如果我們遇到的是這種問題呢 ? 

> 有個表成長速度很快，而且已經非常巨大了，要如何解決呢 ? 

因為就一個表我們當然每辦法用垂直切分，所以這時我們就是要用水平切分，它的定義如下 : 

> 將某個資料表，根據某個欄位或規則，進行切分

但我們選擇選擇`key`來進行切分呢 ? 

我們先來假設情況 :

```
假設我們有張資料表，它是用有存放使用者觀看產品的 log ，然後它有以下欄位 : 

* id
* product_id
* user_id
* create_time
```
這時我們要如何切分呢 ? 答案如下 :

> 看需求

根據上面的需求來看，它竟然是用來存放 log 的，這也代表他應該是寫入操作非常的多，並且我們會想使用這個資訊，找出某段時間的吸引使用者眼球的熱門產品。

所以我們希望進行切分後，我們可以達到『將寫的操作流量頻平均的分配到不同的表，並且可以讓我們快速的搜尋熱門產品』。

訂好目標時，我們就可以開始的選擇我們的切分的`key`也可以稱為`shard key`，首先第一個 id 我們先不考慮，主要原因是，我們不知道他的 id 規則，如果他是根據時間來產生，那選擇它，會發生某段時間的寫入請求全部會流向他。

同理我們`create_time`也不考慮，所以我們這時只剩`product_id`和`user_id`來進行選擇，我們根據我們上面提到的，希望快速搜尋到熱門產品這點，事實上就可以直接選它了，因為我們如果根據它來切分資料，只要我們知道要搜尋的產品是屬於那個表的，那就直接去那個表進行搜尋就好。

當然除了上面的直接從欄位來選擇`shard key`是種方法，還有另一種方法就是將欄位進行`hash`，這樣的好處是可以將資料平均的分散，但缺點就在於，我們不能根據機器的性能來分散資料。

水平切分適合以下的情況 :

> 單表數據量龐大


### 水平切分的選擇
在進行水平切分時，我們需要根據某個欄位為基準進行切分，而大致上會分成以下幾種 : 

#### 範圍切分
像是`日期`就是這類最常見的用法。

這種類型的好處理是，我們如果要進行`搜尋`時，非常的好處理，假設我們是根據日期來切分，那我們只要去指定範圍的地方尋找資料就好，但這種類型的缺點就是流量不容易分散，有可能操作都集中在某一些的範圍的資料表中。

#### Hash 切分
這種類型的切分，就是將所分的區進行編號，然後再透過 hash 來指定分區儲存的資料，它主要追求的就是將操作平均分散。

這種類型的好處就是可以將流量平均的分佈，但缺點就是搜尋沒有像上面的範圍區分著麼的方便。

對了這種切分還有一點要注意 :

> 他不適合資料重複率高的資料

因為相同的資料 hash 值一點會相同，所以重複率高的資料也就代表這，會將它都存到同一個區間中。

#### 列表切分
像是`國家`這種類型的，就是屬於這種切分型式，它主要選用的分區鍵都是屬於`離散型`的資料，離散就是指沒有範圍的資料。

它最主要的優點就是很方便尋找所對應的資料，像是我們以`國家`來區分，那我們想找`台灣`的資料，只要去`台灣`的分區尋找就好。

> 它很適合重複性高的資料

## 切分後所遇到的問題

### 事務處理問題
假設我們只有一台資料庫，那事務操作只要在那一台資料庫上進行處理，但如果是多台呢 ? 例如我們要新增一筆資料到 A 資料庫，然後更新 B 資料庫的東西，這裡的事務，我們要如何處理呢 ? 

如果的一在 MySql 中，它在 5.0 版時，有提供了`分散式事務`的支援，不過注意，它只提供在`Innodb`的引擎上，而且它的系統資源消耗也大。

還有另一種解法，那就是結合`資料庫`與`應用程式`來共同解決，各別的資料庫處理各別的事務，然後使用程式來制多個資料庫上面的事務。



### 數據一致的問題

